databaseChangeLog:
  - changeSet:
      id: 004-fix-kong-product-unique-constraint
      author: system
      preConditions:
        - onFail: MARK_RAN
        - tableExists:
            tableName: kong_product
      changes:
        - sql:
            sql: ALTER TABLE kong_product DROP CONSTRAINT IF EXISTS uk_kong_product_external_id;
        
        - sql:
            sql: ALTER TABLE kong_product DROP CONSTRAINT IF EXISTS uk_kong_product_external_org;
        
        - addUniqueConstraint:
            tableName: kong_product
            columnNames: external_id, organization_id
            constraintName: uk_kong_product_external_org
      
      rollback:
        - sql:
            sql: ALTER TABLE kong_product DROP CONSTRAINT IF EXISTS uk_kong_product_external_org;
        - sql:
            sql: ALTER TABLE kong_product ADD CONSTRAINT uk_kong_product_external_id UNIQUE (external_id);
