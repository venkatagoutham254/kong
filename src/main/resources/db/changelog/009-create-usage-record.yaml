databaseChangeLog:
  - changeSet:
      id: 009-create-usage-record
      author: aforo
      changes:
        - createTable:
            tableName: usage_record
            columns:
              - column:
                  name: usage_id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: correlation_id
                  type: VARCHAR(128)
              - column:
                  name: kong_request_id
                  type: VARCHAR(128)
              - column:
                  name: timestamp
                  type: TIMESTAMP WITH TIME ZONE
                  constraints:
                    nullable: false
              - column:
                  name: consumer_id
                  type: VARCHAR(128)
              - column:
                  name: consumer_username
                  type: VARCHAR(255)
              - column:
                  name: consumer_custom_id
                  type: VARCHAR(255)
              - column:
                  name: service_id
                  type: VARCHAR(128)
              - column:
                  name: service_name
                  type: VARCHAR(255)
              - column:
                  name: route_id
                  type: VARCHAR(128)
              - column:
                  name: route_name
                  type: VARCHAR(255)
              - column:
                  name: request_method
                  type: VARCHAR(10)
              - column:
                  name: request_path
                  type: VARCHAR(2048)
              - column:
                  name: request_size
                  type: BIGINT
              - column:
                  name: request_headers
                  type: TEXT
              - column:
                  name: response_status
                  type: INTEGER
              - column:
                  name: response_size
                  type: BIGINT
              - column:
                  name: response_latency
                  type: BIGINT
              - column:
                  name: upstream_latency
                  type: BIGINT
              - column:
                  name: kong_latency
                  type: BIGINT
              - column:
                  name: metric_type
                  type: VARCHAR(50)
                  defaultValue: calls
              - column:
                  name: billable_units
                  type: DECIMAL(15,4)
                  defaultValueNumeric: 1.0
              - column:
                  name: unit_price
                  type: DECIMAL(15,6)
              - column:
                  name: total_cost
                  type: DECIMAL(15,2)
              - column:
                  name: currency
                  type: VARCHAR(3)
                  defaultValue: USD
              - column:
                  name: processed
                  type: BOOLEAN
                  defaultValueBoolean: false
              - column:
                  name: billed
                  type: BOOLEAN
                  defaultValueBoolean: false
              - column:
                  name: invoice_id
                  type: VARCHAR(50)
              - column:
                  name: organization_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: client_ip
                  type: VARCHAR(45)
              - column:
                  name: user_agent
                  type: VARCHAR(512)
              - column:
                  name: geo_country
                  type: VARCHAR(2)
              - column:
                  name: geo_city
                  type: VARCHAR(100)
              - column:
                  name: tags
                  type: TEXT
              - column:
                  name: metadata
                  type: TEXT
        - createIndex:
            tableName: usage_record
            indexName: idx_usage_timestamp
            columns:
              - column:
                  name: timestamp
        - createIndex:
            tableName: usage_record
            indexName: idx_usage_consumer
            columns:
              - column:
                  name: consumer_id
        - createIndex:
            tableName: usage_record
            indexName: idx_usage_service
            columns:
              - column:
                  name: service_id
        - createIndex:
            tableName: usage_record
            indexName: idx_usage_route
            columns:
              - column:
                  name: route_id
        - createIndex:
            tableName: usage_record
            indexName: idx_usage_correlation
            columns:
              - column:
                  name: correlation_id
        - createIndex:
            tableName: usage_record
            indexName: idx_usage_org_ts
            columns:
              - column:
                  name: organization_id
              - column:
                  name: timestamp
        - addUniqueConstraint:
            tableName: usage_record
            columnNames: correlation_id, organization_id
            constraintName: uk_usage_correlation_org
